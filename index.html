<!DOCTYPE HTML>
<html>


<!-- TODO:
*traiter les erreurs
*bug du ralentissement
*niveaux
*center elements de l'aide memoire
 -->

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<style>
    body{
        font-family: "Arial";
          background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXWBgYGHh4d5eXlzc3OLi4ubm5uVlZWPj4+NjY19fX2JiYl/f39ra2uRkZGZmZlpaWmXl5dvb29xcXGTk5NnZ2c8TV1mAAAAG3RSTlNAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAvEOwtAAAFVklEQVR4XpWWB67c2BUFb3g557T/hRo9/WUMZHlgr4Bg8Z4qQgQJlHI4A8SzFVrapvmTF9O7dmYRFZ60YiBhJRCgh1FYhiLAmdvX0CzTOpNE77ME0Zty/nWWzchDtiqrmQDeuv3powQ5ta2eN0FY0InkqDD73lT9c9lEzwUNqgFHs9VQce3TVClFCQrSTfOiYkVJQBmpbq2L6iZavPnAPcoU0dSw0SUTqz/GtrGuXfbyyBniKykOWQWGqwwMA7QiYAxi+IlPdqo+hYHnUt5ZPfnsHJyNiDtnpJyayNBkF6cWoYGAMY92U2hXHF/C1M8uP/ZtYdiuj26UdAdQQSXQErwSOMzt/XWRWAz5GuSBIkwG1H3FabJ2OsUOUhGC6tK4EMtJO0ttC6IBD3kM0ve0tJwMdSfjZo+EEISaeTr9P3wYrGjXqyC1krcKdhMpxEnt5JetoulscpyzhXN5FRpuPHvbeQaKxFAEB6EN+cYN6xD7RYGpXpNndMmZgM5Dcs3YSNFDHUo2LGfZuukSWyUYirJAdYbF3MfqEKmjM+I2EfhA94iG3L7uKrR+GdWD73ydlIB+6hgref1QTlmgmbM3/LeX5GI1Ux1RWpgxpLuZ2+I+IjzZ8wqE4nilvQdkUdfhzI5QDWy+kw5Wgg2pGpeEVeCCA7b85BO3F9DzxB3cdqvBzWcmzbyMiqhzuYqtHRVG2y4x+KOlnyqla8AoWWpuBoYRxzXrfKuILl6SfiWCbjxoZJUaCBj1CjH7GIaDbc9kqBY3W/Rgjda1iqQcOJu2WW+76pZC9QG7M00dffe9hNnseupFL53r8F7YHSwJWUKP2q+k7RdsxyOB11n0xtOvnW4irMMFNV4H0uqwS5ExsmP9AxbDTc9JwgneAT5vTiUSm1E7BSflSt3bfa1tv8Di3R8n3Af7MNWzs49hmauE2wP+ttrq+AsWpFG2awvsuOqbipWHgtuvuaAE+A1Z/7gC9hesnr+7wqCwG8c5yAg3AL1fm8T9AZtp/bbJGwl1pNrE7RuOX7PeMRUERVaPpEs+yqeoSmuOlokqw49pgomjLeh7icHNlG19yjs6XXOMedYm5xH2YxpV2tc0Ro2jJfxC50ApuxGob7lMsxfTbeUv07TyYxpeLucEH1gNd4IKH2LAg5TdVhlCafZvpskfncCfx8pOhJzd76bJWeYFnFciwcYfubRc12Ip/ppIhA1/mSZ/RxjFDrJC5xifFjJpY2Xl5zXdguFqYyTR1zSp1Y9p+tktDYYSNflcxI0iyO4TPBdlRcpeqjK/piF5bklq77VSEaA+z8qmJTFzIWiitbnzR794USKBUaT0NTEsVjZqLaFVqJoPN9ODG70IPbfBHKK+/q/AWR0tJzYHRULOa4MP+W/HfGadZUbfw177G7j/OGbIs8TahLyynl4X4RinF793Oz+BU0saXtUHrVBFT/DnA3ctNPoGbs4hRIjTok8i+algT1lTHi4SxFvONKNrgQFAq2/gFnWMXgwffgYMJpiKYkmW3tTg3ZQ9Jq+f8XN+A5eeUKHWvJWJ2sgJ1Sop+wwhqFVijqWaJhwtD8MNlSBeWNNWTa5Z5kPZw5+LbVT99wqTdx29lMUH4OIG/D86ruKEauBjvH5xy6um/Sfj7ei6UUVk4AIl3MyD4MSSTOFgSwsH/QJWaQ5as7ZcmgBZkzjjU1UrQ74ci1gWBCSGHtuV1H2mhSnO3Wp/3fEV5a+4wz//6qy8JxjZsmxxy5+4w9CDNJY09T072iKG0EnOS0arEYgXqYnXcYHwjTtUNAcMelOd4xpkoqiTYICWFq0JSiPfPDQdnt+4/wuqcXY47QILbgAAAABJRU5ErkJggg==);
          background-color: BlanchedAlmond;
    }
    .code_and_help{
        /* background-color: red; */
        float:left;
        display: inline-block;
        margin : 5px;
        min-width : 300px;
        min-height : 400px;
        padding: 8px;
        margin-bottom: 10px;
        font-size:1.5em;
        border-radius: 8px;
        margin-top:0;
        padding-top:0;
    }
    #canvas_and_run{
        float:left;
        display: block;
        padding : 5px;
        margin-top:20px;
    }
    #run_pan{
        text-align: center;
        margin : auto;
    }
    #code_pan, #help_pan{
        /* float:left; */
        /* display: block; */
        /* margin : 5px; */
        min-width : 300px;
        min-height : 400px;
        /* padding: 8px; */
        /* margin-bottom: 10px; */
        /* font-size:1.5em; */
        border-radius: 8px;
    }
    #help_pan{
        border:dashed 2px;
    }
    #code_pan{
        font-size:1.2em;
    }
    .title_help{
        font-weight: bold;
        margin:15px;
        font-size: 1.5em;
        text-align: center;
    }
    button{
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        border-radius: 8px;
    }
    button:hover{
        cursor:pointer;
    }

    #run_button, #pause_button{
        color: white;
        font-size: 1.5em;
    }
    #run_button{
        background-color:green;
        border-color:green;
    }
    #pause_button{
        background-color:red;
        border-color:red;
    }
    .help_button{
        font-size: 1.1em;
        display: block;
        background-color: LightBlue;
    }
    .block_lines{
        min-width : 100px;
        min-height: 50px;
        padding : 15px;
        margin : 5px;
        border-style : inset;
        background-color : cyan;
        border-radius: 5px;
    }
    input, select{
        max-width:70px;
        margin:2px;
        font-size: 1em;
    }
    .xremove{
        float:right;
        background-color:red;
        padding:2px;
    }
    .codel{
        background-color:yellow;
        padding : 5px;
        margin : 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 5px;
        /* box-shadow: 5px 5px 10px; */
    }
    .group_repeat, .group_ifwall, .group_else{
        background-color:yellow;
        padding : 5px;
        border-radius: 5px;
    }
    /* .input_repeat{
        border:none;
        box-shadow: none;
    } */
    canvas{
        border-radius: 8px;
        background-color: white;
    }
    #divMouse{
        background-color: rgba(255,255,255,0.8);
		position: fixed;
		border-radius: 5px;
		box-shadow: 5px 5px 10px;
		padding: 10px;
        font-size: 1.5em;
	}
    .example_title{
        color: red;
        margin:20px;
    }

</style>
</head>

<body>

<div id="divMouse" style="display: none;"></div>
<div id="canvas_and_run">
    <div id="canvas_pan">
        <canvas id="icanvas" width=640 height=500></canvas>
    </div>
    <div id="run_pan">
        <button id="run_button" onclick="click_run()"></button>
        <button id="pause_button" onclick="click_pause()"></button>
    </div>
</div>

<script>
    var mapstr = "wwwwwwwwwwwwwwwwwwwwww"+
                 "w       w            w"+
                 "w                    w"+
                 "w      o   *****  w  w"+
                 "w                    w"+
                 "w    w wwwwwwww ww   w"+
                 "w                    w"+
                 "w                    w"+
                 "w        w           w"+
                 "w                    w"+
                 "w    w           w   w"+
                 "w                    w"+
                 "wwwwwwwwwwwwwwwwwwwwww";
    var ny = 13;
    var nx = mapstr.length / ny;
    var INTERVAL = 40;
    var INTERVAL_ANIM = 10;
    var currentRequest = null;
    var FOREVER = "toujours";
    var MOVE = "Avancer:";
    var TXT_AFTER_MOVE = " cases";
    var TURN = "Tourner:";
    var TXT_AFTER_TURN = "";
    var REPEAT = "Répéter:";
    var TXT_AFTER_REPEAT = " fois";
    var IF_WALL = "Si mur";
    var ELSE = "Sinon:";
    var GAME_OVER = "Perdu !";
    var GAME_WON = "Gagné !";
    var RUN = "Executer les ordres";
    var PAUSE = "Stop"
    var HELP_CODE = "Aide-mémoire";
    var HELP_BLOCKS = "Instructions";
    var TITLE_CODE = "Ton code";
    var PLACEHOLDER = "Ecris ton code ici...";
    var tabs4 = "&nbsp;".repeat(4);
    var MODE = "code";
    // var MODE = "blocks";

    document.getElementById("run_button").innerHTML = RUN;
    document.getElementById("pause_button").innerHTML = PAUSE;


    var d = document.createElement("div");
    d.className = "code_and_help";
    document.body.appendChild(d);


    var t = document.createElement("div");
    t.className = "title_help";
    t.innerHTML = TITLE_CODE;
    d.appendChild(t)

    //Create textarea or blocks area
    if(MODE == "blocks"){
        var e = document.createElement("div");
        e.onclick = function (){refresh_current_pan();};
    }
    else if(MODE == "code"){
        // var initial_code = "Avancer:8";
        // var initial_code = "Répéter:toujours\n{\n    Si mur\n    {\n        Tourner:90\n    }\n    Avancer:1\n}"
        var initial_code="";
        var e = document.createElement("textarea");
        e.placeholder = PLACEHOLDER;
        if(initial_code.length > 0){
            var t = document.createTextNode(initial_code);
            e.appendChild(t);
        }
    }
    e.id = "code_pan";
    d.appendChild(e);


    var d = document.createElement("div");
    d.className = "code_and_help";
    document.body.appendChild(d);

    var t = document.createElement("div");
    t.className = "title_help";
    if(MODE=="code")
        t.innerHTML = HELP_CODE;
    else {
        t.innerHTML = HELP_BLOCKS;
    }
    d.appendChild(t);

    //create help area
    var h = document.createElement("div");
    h.id = "help_pan";
    var buttons = [["move_button","click_move();", MOVE],
                    ["turn_button","click_turn();", TURN],
                    ["ifwall_button","click_ifwall();", IF_WALL],
                    ["repeat_button","click_repeat();", REPEAT]];
    var DESCR_MOVE = "Exemple pour avancer de 3 cases";
    var DESCR_TURN = "Exemple pour tourner de 90 degrés";
    var DESCR_IFWALL = "Exemple pour réagir face à un mur";
    var DESCR_REPEAT = "Exemple pour répéter 4 fois des ordres";
    var DESCR_REPEAT_FOREVER = "Pour répéter sans cesse";
    var EXAMPLES_TXT = {"move_button":'<div class="example_title">' +
                                        DESCR_MOVE + "</div>" + MOVE+" 3",
                        "turn_button":'<div class="example_title">' +
                                        DESCR_TURN + "</div>" + TURN+" 90",
                        "ifwall_button":'<div class="example_title">' +
                                        DESCR_IFWALL + "</div>" + IF_WALL +
                                        "<br>{<br>" + tabs4 + "...<br>}",
                        "repeat_button":'<div class="example_title">' +
                                        DESCR_REPEAT + "</div>" + REPEAT + " 4" +
                                        "<br>{<br>" + tabs4 + "...<br>}"+

                                        '<div class="example_title">' +
                                        DESCR_REPEAT_FOREVER + "</div>" + REPEAT + " toujours" +
                                        "<br>{<br>" + tabs4 + "...<br>}"
                        };
    function attribute_help(item, index) {
        var b = document.createElement("button");
        b.className = "help_button";
        b.id = item[0];
        var txt = item[2].replace(":","");
        if(MODE=="blocks")
        {
            b.onclick = function(){eval(item[1]);}
        }
        else{
            // b.style.pointerEvents = "none";
            var example = document.createElement("div");
            b.setAttribute("onmouseover", "mouseOver(this)");
            b.setAttribute("onmouseout", "mouseOut()");
            b.appendChild(example);
        }
        b.innerHTML = txt;
        h.appendChild(b);
    }
    buttons.forEach(attribute_help);
    d.appendChild(h);


    var CELL_SIZE = 32;
    var VELOCITY; //must be a divider of cell size
    var icode = 0;
    var frame = 0;
    var user_code = [];
    var gameover = false;
    var canvas = document.getElementById('icanvas');
    canvas.width = nx*CELL_SIZE;
    canvas.height = ny*CELL_SIZE;
    var context = canvas.getContext("2d");
    var img_obj = {
        'source': null,
        'current': 0,
        'total_frames': 6,
        'width': 32,
        'height': 32,
        'x' : 2*CELL_SIZE,
        'y' : parseInt(ny/2*CELL_SIZE),
        'vx' : 0,
        'vy' : 0,
        'velocity' : VELOCITY
    };
    var nframes = {'left' : 6, 'right' : 6, 'up' : 4, 'down' : 4};
    var vel = {'left' : [-1,0], 'right' : [1,0], 'up' : [0,-1], 'down' : [0,1]};
    var orientation_seq = ['left','up','right','down'];
    var img = new Image();
    var goal_x;
    var goal_y;
    var goal_achieved = true;
    var n_repeat = [1];
    var instructions_repeat = [user_code];
    var icode_repeat = [-1];
    var wall_v = new Image();
    wall_v.src = "./wall_v.png"
    var wall_h = new Image();
    wall_h.src = "./wall_h.png"
    var gold = new Image();
    gold.src = "./coin_rotate_32.png"
    var walls_h = [];
    var walls_v = [];
    var coins = [];
    var coins_took = 0;
    var n_coins_initial;
    var current_pan = document.getElementById("code_pan");
    var sound_coin = new Audio('coin.wav');
    initialize_run();

    function get_cell(){
        return pix_to_cell(img_obj.x+CELL_SIZE/2, img_obj.y+CELL_SIZE/2)
    }

    function pix_to_cell(x,y){
        var cx = parseInt(x/CELL_SIZE);
        var cy = parseInt(y/CELL_SIZE);
        return [cx,cy];
    }

    function orientation_from_vel(){
        if(img_obj.vx > 0)
            return 'right';
        else if(img_obj.vx < 0)
            return 'left';
        else if(img_obj.vy > 0)
            return 'down';
        else if(img_obj.vy < 0)
            return 'up';
        else
            console.log("Invalid velocity");
    }

    function set_char_orientation(what){ //bouton stop ; else ; monnaie ; explications
        img_obj.total_frames = nframes[what];
        img_obj.current = 0;
        img_obj.source = img;
        img_obj.source = img;  // we set the image source for our object.
        img.src = './char1_' + what + '.png';
        img_obj.vx = vel[what][0];
        img_obj.vy = vel[what][1];
    }

    function process_user_code(){
        frame += 1;
        if(frame < INTERVAL/10){
            img_obj.velocity = 0;
            return '';
        }
        if(!goal_achieved){
            return '';
        }
        else{
            // console.log("");
            // console.log("***");
            // console.log("instructions", instructions_repeat.slice());
            // console.log("icode_repeat before increment", icode_repeat.slice());
            // console.log("nrepeat", n_repeat.slice());
            var level = instructions_repeat.length - 1; //index of current code
            var current_code = instructions_repeat[level].slice();
            icode_repeat[level] += 1;
            // console.log("level=",level, "i=", icode_repeat[level]);
            if(icode_repeat[level] >= current_code.length){
                // console.log("============>");
                if(level == 0){ //end of program
                    img_obj.velocity = 0;
                    img_obj.current = 0
                    // console.log("END OF PROGRAM");
                    // console.log(img_obj.x);
                    gameover = true;
                    return '';
                }
                else{
                    n_repeat[level] -= 1;
                    if(n_repeat[level] == 0){ //end of loop
                        n_repeat.pop();
                        instructions_repeat.pop();
                        icode_repeat.pop();
                        // console.log("END OF LOOP");
                        return '';
                    }
                    else{
                        icode_repeat[level] = 0; //repeat the loop from zero
                    }
                }
            }
        }
        var codeline = current_code[icode_repeat[level]];
        // console.log("CURRENT_CODE", current_code.slice(), icode_repeat.slice());
        // console.log("level and icode_repeat[level]", level, icode_repeat[level]);
        // console.log("       codeline", codeline);
        ////////////////////////////////////////////////////////////////////////
        if(codeline[0].includes(MOVE)){
            set_char_goal_pos(codeline[1]);
        }
        else if(codeline[0].includes(TURN)){
            turn_char(codeline[1]);
        }
        else{
            if(codeline[0].includes(REPEAT)){
                var n = codeline[1];
                var instructions = codeline[2];
                // console.log("LOG REPEAT", instructions.slice());
                n_repeat.push(n);
                instructions_repeat.push(instructions);
                icode_repeat.push(-1);
            }
            else if(codeline[0].includes(IF_WALL) && next_is_wall()){
                    var instructions = codeline[1];
                    // console.log("LOG IF WALL", instructions.slice(), char_touch_wall());
                    n_repeat.push(1); //"if" is just a loop that we take once
                    instructions_repeat.push(instructions);
                    icode_repeat.push(-1);
            }
        }
        return codeline;
    }

    function next_is_wall(){
        //var x = img_obj.x + img_obj.vx * img_obj.velocity + CELL_SIZE/2;
        //var y = img_obj.y + img_obj.vy * img_obj.velocity + CELL_SIZE/2;
        /*
        if(goal_x === null || goal_y === null)
            return false;
        var x = goal_x + CELL_SIZE/2;
        var y = goal_y + CELL_SIZE/2;
        var coord = pix_to_cell(x,y);
        */
        var coord = get_cell();
        coord[0] += img_obj.vx;
        coord[1] += img_obj.vy
        if(is_wall(coord)){ //topleft
            return true;
        }
        return false;
    }

    function set_char_goal_pos(argument){
        img_obj.velocity = VELOCITY;
        goal_x = img_obj.x + img_obj.vx * argument * CELL_SIZE;
        goal_y = img_obj.y + img_obj.vy * argument * CELL_SIZE;
        var future_pos = pix_to_cell(goal_x+CELL_SIZE/2, goal_y+CELL_SIZE/2);
        goal_achieved = false;
    }

    function turn_char(argument){
        //assert argument is a multiple of 90
        var quarters = argument / 90;
        var old_orientation = orientation_from_vel();
        var current_idx = orientation_seq.indexOf(old_orientation);
        var new_idx = (current_idx + quarters) % orientation_seq.length;
        var new_orientation = orientation_seq[new_idx];
        set_char_orientation(new_orientation);
        img_obj.velocity = 0;
        goal_achieved = true;
    }

    function check_conditions(){
        if(goal_x == img_obj.x && goal_y == img_obj.y){
            // console.log("Goal position ok");
            goal_achieved = true;
            img_obj.velocity = 0;
        }
        else if(char_touch_wall()){
            console.log("Game over touch wall", get_cell());
            context.font = "40px Arial";
            context.rect(0,0,canvas.width,canvas.height);
            context.fillStyle = "rgba(255, 255, 255, 0.5)";
            context.fill();
            context.fillStyle = "red";
            context.fillText(GAME_OVER, canvas.width/2, canvas.height/2);
            img_obj.velocity = 0
            gameover = true;
        }
        else if(char_touch_coin()){
            remove_coin(get_cell());
            if(coins_took == n_coins_initial){
                gameover = true;
                context.font = "40px Arial";
                context.rect(0,0,canvas.width,canvas.height);
                context.fillStyle = "rgba(255, 255, 255, 0.5)";
                context.fill();
                context.fillStyle = "green";
                context.fillText(GAME_WON, canvas.width/2, canvas.height/2);
            }

        }
    }

    function draw_anim() { // context is the canvas 2d context.
        // console.log("***draw***");
        context.clearRect(0, 0, canvas.width, canvas.height);  // clear canvas
        draw_grid();
        context.drawImage(img_obj.source, img_obj.current * img_obj.width, 0,
                              img_obj.width, img_obj.height,
                              img_obj.x, img_obj.y, img_obj.width, img_obj.height);
        draw_walls();
        draw_gold();
        if(img_obj.velocity == 0){
            img_obj.current = 0;
        }
        else{
            img_obj.current = (img_obj.current + 1) % img_obj.total_frames;
            img_obj.x += img_obj.vx * img_obj.velocity;
            img_obj.y += img_obj.vy * img_obj.velocity;
        }
    }

    function draw_gold(){
         for (var i=0; i < coins.length; i++){
            var infos = coins[i];
            var current = infos[2];
            context.drawImage(gold, current * 32, 0,
                              32, 32,
                              infos[0]*CELL_SIZE, infos[1]*CELL_SIZE, 32, 32);
            if(frame%5 == 0){
                current = (current+1)%2;
                coins[i][2] = current;
            }
        }
    }

    function draw_grid(){
        for (var x = 0.; x < canvas.width; x += CELL_SIZE) {
          context.moveTo(x, 0);
          context.lineTo(x, canvas.height);
        }
        for (var y = 0.; y < canvas.height; y += CELL_SIZE) {
          context.moveTo(0, y);
          context.lineTo(canvas.width, y);
        }
        context.moveTo(0,0);
        context.strokeStyle = "#ddd";
        context.stroke();
        /*
        var coord = get_cell();
        context.fillStyle = "blue";
        context.fillRect(coord[0]*CELL_SIZE,coord[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
        */
    }

    function pretty_walls(){
        var new_map = "";
        for(var i=0; i<mapstr.length; i++){
            if (mapstr[i] == "w"){
                var x = i%nx;
                var y = parseInt(i/nx);
                var i_bottom = nx * (y+1) + x;
                var below_is_wall = "whv".includes(mapstr[i_bottom]);
                if(i_bottom >= mapstr.length || below_is_wall)
                    new_map += "v";
                else
                    new_map += "h";
            }
            else
                new_map += mapstr[i];
        }
        mapstr = new_map;
    }

    function draw_walls(){
        for (var i=0; i < walls_v.length; i++){
            var pix = [walls_v[i][0]*CELL_SIZE, walls_v[i][1]*CELL_SIZE];
            context.drawImage(wall_v, pix[0], pix[1]);
        }
        for (var i=0; i < walls_h.length; i++){
            var pix = [walls_h[i][0]*CELL_SIZE, walls_h[i][1]*CELL_SIZE];
            context.drawImage(wall_h, pix[0], pix[1]);
        }
    }

    function is_wall(coord){
        if (coord[0] >= nx)
            return true;
        else if(coord[0] < 0)
            return true;
        else if(coord[1] >= ny)
            return true;
        else if (coord[1] < 0)
            return true;
        var i = nx * coord[1] + coord[0];
        return mapstr[i]=="v" || mapstr[i]=="h";
    }

    function is_gold(coord){
        var i = nx * coord[1] + coord[0];
        return mapstr[i]=="*";
    }

    function set_mapstr(coord, symbol){
        var i = nx * coord[1] + coord[0];
        mapstr[i] = symbol;
    }

    function remove_coin(coord){
        for(var i=0;i<coins.length;i++){
            if(coins[i][0] == coord[0] && coins[i][1] == coord[1]){
                sound_coin.pause();
                sound_coin.currentTime = 0;
                sound_coin.play();
                coins.splice(i,1);
                set_mapstr(coord, " ");
                coins_took ++;
                break;
            }
        }
    }

    function char_touch_coin(){
        return is_gold(get_cell());
    }

    function char_touch_wall(){
        if(is_wall(get_cell())){ //topleft
            return true;
        }
        /*
        else{ //bottom right
            var delta = parseInt(0.75*CELL_SIZE);
            var x = img_obj.x + delta;
            var y = img_obj.y + delta;
            x = parseInt(x/CELL_SIZE);
            y = parseInt(y/CELL_SIZE);
            return is_wall([x,y]);
        }*/
    }

    function click_run(){
        //clearInterval(intervalMainLoop);
        user_code = get_user_code();
        console.log("USER CODE", user_code);
        initialize_run();
        console.log("START MAIN LOOP");
        //intervalMainLoop = setInterval(function(){ main_loop(); }, INTERVAL);
        if(currentRequest != null){
            cancelAnimationFrame(currentRequest);
            currentRequest = null;
        }
        currentRequest = requestAnimationFrame(main_loop);
    }

    function initialize_run(){
        if(currentRequest != null){
            cancelAnimationFrame(currentRequest);
            currentRequest = null;
        }
        VELOCITY = 4; //must be a divider of cell size
        icode = 0;
        frame = 0;
        goal_x = null;
        goal_y = null;
        goal_achieved = true;
        gameover = false;
        n_repeat = [1];
        instructions_repeat = [user_code];
        icode_repeat = [-1];
        walls_v = [];
        walls_h = [];
        coins = [];
        pretty_walls();
        for(var i=0; i<mapstr.length; i++){
            var x = i%nx;
            var y = parseInt(i/nx);
            if(mapstr[i]=="v")
                walls_v.push([x,y])
            else if(mapstr[i]=="h")
                walls_h.push([x,y])
            else if(mapstr[i]=="o"){
                img_obj.x = x*CELL_SIZE;
                img_obj.y = y*CELL_SIZE;
            }
            else if(mapstr[i]=="*"){
                coins.push([x,y,i%2]);
            }
        }
        img_obj.vx = 0;
        img_obj.vy = 0;
        img_obj.velocity = VELOCITY
        set_char_orientation('right', img_obj);
        n_coins_initial = coins.length;
    }


    function main_loop(){
        check_conditions();
        if(!gameover){
            process_user_code();
            draw_anim();
            currentRequest = requestAnimationFrame(main_loop);
        }

    }

    function get_code_element(what, txt_after, base){
        var code = what + base + txt_after;
        return code;
    }

    function create_xrem(){
        var xrem = document.createElement("button");
        xrem.innerHTML = "x";
        xrem.className = "xremove";
        xrem.onclick = function (){
            var p = this.parentElement;
            var cn = this.parentElement.className;
            if( cn == "codel repeat" || cn == "codel ifwall" || cn == "codel else"){
                p.parentElement.parentElement.removeChild(p.parentElement);
            }
            else{
                p.parentElement.removeChild(p);
            }
        }
        return xrem;
    }

    function click_repeat(){
        var base = '<input type="number" value="2" class="input_repeat">';
        var code = get_code_element(REPEAT, TXT_AFTER_REPEAT, base);
        var node = document.createElement("div");
        node.className = "codel repeat";
        node.innerHTML = code;
        var xrem = create_xrem();
        node.appendChild(xrem);
        //
        var more = document.createElement("div");
        if(current_pan.className == "block_lines"){
            more.level = current_pan.level + 1;
        }
        else{
            more.level = 1;
        }
        more.className = "block_lines";
        //
        var group = document.createElement("div");
        group.className = "group_repeat";
        group.appendChild(node);
        group.appendChild(more);
        current_pan.appendChild(group);
        set_current_pan(more);
    }

    function click_move(){
        var base = '<input type="number" value="1" class="input_move">';
        var code = get_code_element(MOVE, TXT_AFTER_MOVE, base);
        var node = document.createElement("div");
        node.className = "codel move";
        node.innerHTML = code;
        var xrem = create_xrem();
        node.appendChild(xrem);
        current_pan.appendChild(node);
    }

    function click_turn(){
        var base = '<select class="input_turn">' +
                      '<option value="90"> 90° </option>' +
                      '<option value="180"> 180° </option>' +
                      '<option value="270"> 270° </option>' +
                    '</select>';
        var code = get_code_element(TURN, TXT_AFTER_TURN, base);
        var node = document.createElement("div");
        node.className = "codel turn";
        node.innerHTML = code;
        var xrem = create_xrem();
        node.appendChild(xrem);
        current_pan.appendChild(node);
    }

    function click_ifwall(){
        var base = "";
        var code = get_code_element(IF_WALL, "", base);
        var node = document.createElement("div");
        node.className = "codel ifwall";
        node.innerHTML = code;
        var xrem = create_xrem();
        node.appendChild(xrem);
        var more = document.createElement("div");
        if(current_pan.className == "block_lines"){
            more.level = current_pan.level + 1;
        }
        else{
            more.level = 1;
        }
        more.className = "block_lines";
        //
        var group = document.createElement("div");
        group.className = "group_ifwall";
        group.appendChild(node);
        group.appendChild(more);
        current_pan.appendChild(group);
        set_current_pan(more);
    }

    function click_else(){
        var base = "";
        var code = get_code_element(ELSE, "", base);
        var node = document.createElement("div");
        node.className = "codel else";
        node.innerHTML = code;
        var xrem = create_xrem();
        node.appendChild(xrem);
        var more = document.createElement("div");
        if(current_pan.className == "block_lines"){
            more.level = current_pan.level + 1;
        }
        else{
            more.level = 1;
        }
        more.className = "block_lines";
        //
        var group = document.createElement("div");
        group.className = "group_else";
        group.appendChild(node);
        group.appendChild(more);
        current_pan.appendChild(group);
        set_current_pan(more);
    }

    function collect_user_code(e, code, level){
        var children = e.childNodes;
        var prefix = "#".repeat(level); //not needed, but more readable
        console.log("COLLECT", prefix);
        for(var i=0; i<children.length; i++){
            var child = children[i];
            if (child.innerHTML === undefined){
            //special treatment
            }
            else{
                console.log(child.innerHTML);
                if(child.className == "codel move"){
                    var el = child.getElementsByClassName('input_move')[0];
                    code.push(MOVE + el.value);
                    console.log("APPEND", prefix + MOVE + el.value);
                }
                else if(child.className == "codel turn"){
                    var el = child.getElementsByClassName('input_turn')[0];
                    code.push(TURN + el.value);
                    console.log("APPEND",prefix + TURN + el.value);
                }
                else if(child.className == "group_repeat"){
                    var el = child.getElementsByClassName('input_repeat')[0];
                    code.push(REPEAT + el.value);
                    code.push("{");
                    console.log("APPEND", prefix + REPEAT + el.value);
                    var e = child.getElementsByClassName('block_lines')[0]
                    collect_user_code(e, code, level+1);
                    code.push("}");
                }
                else if(child.className == "group_ifwall"){
                    code.push(IF_WALL);
                    console.log("APPEND", prefix + IF_WALL);
                    code.push("{");
                    var e = child.getElementsByClassName('block_lines')[0]
                    collect_user_code(e, code, level+1);
                    code.push("}");
                }
            }
        }
    }


    function transpile_user_code(collected, to_treat, code, level){
        console.log("COLLECT", level);
        for(var i=0; i<to_treat.length; i++){
            var sep = to_treat[i].split(":");
            console.log("TREAT", to_treat[i], sep);
            if(to_treat[i].includes(MOVE)){
                console.log("   move");
                code.push([MOVE, parseInt(sep[1])]);
            }
            else if(to_treat[i].includes(TURN)){
                console.log("   turn");
                code.push([TURN, parseInt(sep[1])]);
            }
            else{
                var inner_lines = get_inner_lines(to_treat, i);
                console.log("   INNER LINES", inner_lines);
                var inner_code = []
                transpile_user_code(collected, inner_lines, inner_code, level+1);
                if(to_treat[i].includes(REPEAT)){
                    var n = parseInt(sep[1]);
                    code.push([REPEAT, n, inner_code]);
                }
                else if(to_treat[i].includes(IF_WALL))
                    code.push([IF_WALL, inner_code]);
                else
                    console.log("AFFICHER MSG ERREUR");
                i += inner_lines.length + 2;
            }
        }
    }

    function get_inner_lines(collected, icode){
        instructions = [];
        var i = icode + 2;
        var counter_open = 0;
        console.log("enter inner", i, collected);
        while(i < collected.length){
            console.log("       inner", collected[i]);
            if(collected[i].startsWith('{'))
                counter_open++;
            else if(collected[i].startsWith('}'))
                counter_open--;
            if(counter_open < 0){
                break;
            }
            else
                instructions.push(collected[i]);
            i++;
        }
        return instructions;
    }

    function get_user_code(){
        /*
        var e = document.getElementById("code_pan");
        var collected = [];
        collect_user_code(e, collected, 0);
        */
        /*
        var collected = [MOVE + "5",
                        REPEAT + "4",
                        "{",
                            REPEAT + "4",
                            "{",
                                TURN + "90",
                                MOVE + "1",
                            "}",
                            TURN + "90",
                            MOVE + "3",
                        "}",
                        MOVE + "10"];
        */
        /*
        var collected = [REPEAT + "10000",
                        "{",
                            REPEAT + "3",
                            "{",
                                IF_WALL,
                                "{",
                                    TURN + "90",
                                "}",
                            "}",
                            MOVE + "1",
                        "}"];
        */
        var value = document.getElementById("code_pan").value.split("\n");
        var collected = []
        for(var i=0; i<value.length; i++){
            var txt = value[i].trim();
            txt = txt.replace(FOREVER, "1000000");
            collected.push(txt);
        }
        console.log("COLLECTED:");
        console.log(collected);
        var code = [];
        transpile_user_code(collected, collected, code, 0);
        return code;
    }

    function refresh_current_pan(){
        var DEF_COLOR = "cyan";
        var candidates = document.getElementsByClassName("block_lines");
        var highest_level = 0;
        for(var i=0; i<candidates.length; i++){
            var e = candidates[i];
            e.style.backgroundColor = DEF_COLOR;
            if(e.matches(":hover")){
                if(e.level > highest_level){
                    current_pan = e;
                    highest_level = e.level;
                }
            }
        }
        if(highest_level == 0)
            current_pan = document.getElementById("code_pan");
        else
            current_pan.style.backgroundColor = "red";
    }

    function set_current_pan(e){
        var DEF_COLOR = "cyan";
        var candidates = document.getElementsByClassName("block_lines");
        for(var i=0; i<candidates.length; i++){
            var e = candidates[i];
            e.style.backgroundColor = DEF_COLOR;
        }
        current_pan = e;
        current_pan.style.backgroundColor = "red";
    }

    var textareas = document.getElementsByTagName('textarea') + document.getElementsByTagName('placeholder');
    var count = textareas.length;
    for(var i=0;i<count;i++){
        textareas[i].onkeydown = function(e){
            if(e.keyCode==9 || e.which==9){
                e.preventDefault();
                var s = this.selectionStart;
                this.value = this.value.substring(0,this.selectionStart) + "    " + this.value.substring(this.selectionEnd);
                this.selectionEnd = s + "    ".length;
            }
        }
    }

    $("textarea").keydown(function(e){
    if(e.keyCode == 13){

        // assuming 'this' is textarea

        var cursorPos = this.selectionStart;
        var curentLine = this.value.substr(0, this.selectionStart).split("\n").pop();
        var indent = curentLine.match(/^\s*/)[0];
        var value = this.value;
        var textBefore = value.substring(0,  cursorPos );
        var textAfter  = value.substring( cursorPos, value.length );

        e.preventDefault(); // avoid creating a new line since we do it ourself
        this.value = textBefore + "\n" + indent + textAfter;
        setCaretPosition(this, cursorPos + indent.length + 1); // +1 is for the \n
    }
});

function setCaretPosition(ctrl, pos)
{

    if(ctrl.setSelectionRange)
    {
        ctrl.focus();
        ctrl.setSelectionRange(pos,pos);
    }
    else if (ctrl.createTextRange) {
        var range = ctrl.createTextRange();
        range.collapse(true);
        range.moveEnd('character', pos);
        range.moveStart('character', pos);
        range.select();
    }
}

    function click_pause(){
        gameover = true;
        //clearInterval(intervalMainLoop);
    }

    function initial_situation(){
        frame++;
        if(frame%INTERVAL_ANIM == 0){
            draw_anim();
        }
        currentRequest = requestAnimationFrame(initial_situation);
    }


    var current_example_hover = "";
    function mouseOver(e){
        if(e != current_example_hover){
            current_example_hover = e
            var event = window.event;
            var divMouse = document.getElementById('divMouse');
            divMouse.style.left = event.clientX + 5 + "px";
            divMouse.style.top = event.clientY + 5 + "px";
            divMouse.style.display = 'block';
            divMouse.innerHTML = EXAMPLES_TXT[e.id];
        }
    }

    function mouseOut(){
        current_example_hover = "";
        document.getElementById('divMouse').style.display = "none";
    }

    document.onmousemove = handleMouseMove;
    function handleMouseMove(event) {
        if(current_example_hover != ""){
            event = event || window.event; // IE-ism
            var divMouse = document.getElementById('divMouse');
            divMouse.style.left = event.clientX + 5 + "px";
            divMouse.style.top = event.clientY + 5 + "px";
        }
    }

    initialize_run();
    frame = 0;
    img_obj.velocity = 1;
    var k = 0;
    //intervalMainLoop = setInterval(function(){ frame++;draw_anim(); }, INTERVAL);
    currentRequest = requestAnimationFrame(initial_situation);
    img_obj.velocity = 0;
</script>

</body>

</html>
